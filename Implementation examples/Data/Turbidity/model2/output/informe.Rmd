---
title: "Método Turbidez"
author: "Guido Marconi"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(jsonlite)
library(tidyverse)
library(pls)
library(caret)
library(gridExtra)

read_spectra = function(path){
  File = read_json( path)
  
  TurbiSpectra = map(File,function(x){x %>% .[["spectrum"]] %>% unlist()}) %>% bind_cols() %>% t() %>% as_tibble()
  ID = map(File,function(x){x %>% .[["tag"]] %>% strsplit("-") %>% unlist()}) %>% bind_cols() %>% t() %>% as_tibble()
  SiD = map(File,function(x){x %>% .[["ID"]] %>% unlist()}) %>% bind_cols() %>% t() %>% as_tibble()
  
  colnames(TurbiSpectra) = 1:512
  colnames(ID) = c("NTU","LED")
  TurbiSpectra = bind_cols(TurbiSpectra,ID) 
  TurbiSpectra$ID = SiD$V1  
  return(TurbiSpectra)
}

calibration = read_spectra("../data/Curva.json")
test = read_spectra("../data/TEST.json")
calibration2 = read_spectra(path = "../data/CurvaDef.json")
blanco = read_spectra("../data/Blanco.json")
colnames(blanco)[1:512] = paste0("p",1:512)

colnames(calibration)[1:512] = paste0("p",1:512)
colnames(calibration2)[1:512] = paste0("p",1:512)
colnames(test)[1:512] = paste0("p",1:512)

AllData = bind_rows(calibration,calibration2,test)
AllData$NTU = AllData$NTU %>% as.numeric()
AllData = AllData %>% select(-ID)

AllData = AllData %>% filter(NTU <501,NTU >19)
allTidy = AllData %>% group_by(LED) %>% nest()
allTidy$data = allTidy$data %>% map(function (x) {x[-c(1,3,29:38),]})

```

# Desarrollo de método de medición de turbidez con el Ecofisiómetro

## Reseña:
La turbidez es una expresión de la propiedad óptica  que causa la dispersión y absorción de la luz, en lugar de su transmisión, al mantener la dirección y flujo lumínico constante a través de la muestra. La turbidez en el agua está causada por materia suspendida y coloidal, pudiendo ser de origen inorgánico (arcillas, limo, cenizas, etc) u orgánico (materia orgánica particulada, células en suspensión, etc.). Como unidad de medición de turbidez se utiliza a las "Unidades Nephelometricas de Turbidez" (NTU), por sobre las tradicionales Unidades de Turbidez de Jackson (JTU), por su menor sensibilidad a cambios instrumentales.

## Metodología:

Para evitar discrepancias en el tipo de material particulado empleado para calibrar métodos turbidimétricos, se utilizará el estandar primario de polímero de formazina, propuesto en la metodología standard APHA 23-2130 (2017)$^{1}$ .

Brevemente, un primer experimento fue llevado a cabo para determinar los rangos operativos del método de calibración. Con estos fines, se hizo una curva de calibración que comprendía un rango entre 0 y 1000 NTU. Admás se realizaron 20 mediciones del blanco (agua calidad mili-q) para estimar un límite de cuantificación.

Una vez establecidos los límites de cuantificación, y teniendo en cuenta que el objetivo es trabajar con muestras de aguas residuales, se procedió a generar un pull de calibración comprendido en el rango de 20 a 500 NTU. Este consistió de 32 soluciones preparadas a lo largo de  dos semanas. Se procedió a realizar un análisis exploratorio de datos para seleccionar las zonas del espectro más correlacionadas con la variable respuesta. Dicho análisis fue gráfico y mediante análisis de componentes principales.

Se entrenaron una serie de modelos, probando su desempeño usando sumbuestreo aleatorio repetido. Se utilizó debido a que la segmentación en conjunto de testeo y calibración no se encuentra recomendada para menos de 40 datos $^{2}$. Se utilizaron 8 muestras para testear el desempeño del modelo, estimando el modelo con 26 muestras. Se realizaron 200 repeticiones para estimar el error absoluto medio de cada modelo.


## Resultados:

Aquí sólo se incluye la documentación referida al modelo final seleccionado, luego de la exploración de potenciales candidatos resultantes de aplicar una metodología similar utilizando distintas fuentes de iluminación y tratamiento de los datos. 

### Análisis exploratorio

Los espectros de la luz dispersada, resultantes de iluminar las muestras con el led con máximo de emisión a 660 nm (fig. 1), y el biplot (fig. 3) no evidencian datos atípicos con lo que se procederá a utilizar todo los datos. Las variables que más varianza en la base de datos generan pueden verse el gráfico de loadings (fig. 2) para cada pixel, en el primer componente principal. Al comparar la fig 2 y la 1 puede verse que las variables que los píxeles que más varianza explican son aquellos que coinciden con los picos del espectro, por lo que se eligió un punto cercano al máximo de emisión (pixel 150). La señal medida por el pixel 431 en función de la turbidez (fig. 4) muestra una tendencia a incrementar con la turbidez linealmente.

```{r echo=FALSE,fig.cap="Espectros obtenidos al iluminar la muestra con el LED de 660 nm"}
allTidy$Gathered = allTidy$data %>%map(function(x){gather(x,pixel,value,1:512) %>% mutate(pixel = pixel %>% str_extract("\\d+") %>% as.numeric())})
allTidy$Gathered = allTidy$Gathered %>% map(function(x){x %>% mutate(NTU = NTU %>% as_factor) })

allTidy$spectralPlots = map(allTidy$Gathered,function(x){ggplot(x,aes(pixel,value,colour = NTU)) + geom_point(size = 0.1) + ylab("Intensidad (UA)")})
allTidy$spectralPlots[[1]] = allTidy$spectralPlots[[1]] + ggtitle("Transmitancia")
allTidy$spectralPlots[[2]] = allTidy$spectralPlots[[2]] + ggtitle("Scattering 365nm")
allTidy$spectralPlots[[3]] = allTidy$spectralPlots[[3]] + ggtitle("Scattering 395nm")
allTidy$spectralPlots[[4]] = allTidy$spectralPlots[[4]] + ggtitle("Scattering 440nm")
allTidy$spectralPlots[[5]] = allTidy$spectralPlots[[5]] + ggtitle("Scattering 470nm")
allTidy$spectralPlots[[6]] = allTidy$spectralPlots[[6]] + ggtitle("Scattering 530nm")
allTidy$spectralPlots[[7]] = allTidy$spectralPlots[[7]] + ggtitle("Scattering 600nm")
allTidy$spectralPlots[[8]] = allTidy$spectralPlots[[8]] + ggtitle("Scattering 660nm")

allTidy$spectralPlots[[8]]
allTidy$PCA = allTidy$data %>% map(function(x){x[1:512] %>% prcomp(scale = F)})
```

```{r echo=FALSE, fig.cap="Loadings del primer componente principal, explicando el 93,97% de la varianza en el conjunto datos, indicando los píxeles que más aportan a la varianza de la base de datos"}
allTidy$PCA[[8]]$rotation[,1] %>% plot(main = "loadings PC1 (93.97%)")
```

```{r echo=FALSE,fig.cap="Biplot de los primeros dos componentes, mostrando ordenamiento de los datos tras la reducción dimensional"}
allTidy$PCA[[8]] %>% biplot(var.axes = F,main = "PC1 vs PC2")
```

```{r echo=FALSE,fig.cap="Respuesta del equipo, en el pixel seleccionado, a distintos niveles de turbidez"}
ggplot(allTidy$data[[8]],aes(NTU,p431)) + geom_point() + ylab("señal (UA)")
```


### Desarrollo del modelo


El modelo con mejor ajuste resultó ser un modelo lineal simple, ajustado con OLS. $$NTU = \beta_{0} + \beta_{1}S_{p431} + \epsilon$$ 

#### Validez

El modelo seleccionado no presenta patrones en los observables en el gráfico de residuos vs predichos, corroborando el supuesto de independencia. El supuesto de homocedasticidad se verifica al inspeccionar el gráfico de residuos vs predichos y tras realizar al prueba de Goldfeld-Quandt ($pval_{gq} = 0.2$). La tabla ANOVA muestra que el modelo y sus términos son estadísiticamente significativos. La validez del supuesto de normalidad de los residuos no se cumple al rechazar la hipótesis nula de normalidad del test de shapiro wilks ($pval_{shapiro wilks} = 0.008$) ni mediante la inspección gráfica del QQplot.

```{r echo=FALSE,fig.cap="Tabla de ANOVA del modelo"}
Control = caret::trainControl(method = "repeatedcv",repeats = 200,number = 8)
modelo = caret::train(NTU ~ p431 ,
                    data = allTidy$data[[8]],
                    method = "lm",trControl = Control)
modelo$finalModel %>% summary# %>% knitr::kable()

```

```{r echo=FALSE,fig.cap="Gráfico de control"}
par(mfrow=c(2,2))
plot(modelo$finalModel)
```

#### Performance

El modelo seleccionado presenta un error medio absoluto de 11.56 NTU lo que representa un error medio del 7.8%. El promedio de predicciones de concentración tras medir blancos (n = 16) resultó de 18.36 NTU y el desvío estándar de 1.66, por lo que el límite de detección de la técnica se estima en 23.33 NTU.

```{r echo=FALSE,fig.cap="performance de todos los modelos"}
modelo$results %>% mutate("errorPorcentualMedio" = (MAE/mean(allTidy$data[[4]]$NTU)*100)) %>% select(RMSE,MAE,Rsquared,errorPorcentualMedio) %>% knitr::kable(align = "c")
```

## Discusión:

Los resultados muestran que el ecofisiómetro pudo ser calibrado para medir turbidez entre a 23.33 NTU y 500 NTU con un error absoluto promedio de 11.56 NTU, utilizando el siguiente modelo estadístico.  $$\hat{NTU} = 5.54 + 0.12S_{p431}$$ Trabajos previos $^{3}$ han reportado que los valores de turbidez encontrados en aguas residuales afluentes ronda las $201 \pm 114 NTU$. Esto hace al rango operativo de la curva adecuado a los fines de este estudio, puesto que puede resultaría útil en aproximadamente el 94% de los casos. Al encontrarse el promedio de la curva de calibración (148.28 NTU) cerca de la media ambienta, es esperable que el error porcentual de predicción sea menor. A pesar que se viola el supuesto de normalidad, se considera que los modelos lineales ajustados con OLS son robustos ante falta de normalidad.

## Conclusión

Se pudo calibrar un modelo para estimar la turbidez en unidades neftelométricas, acorde a las necesidades del trabajo a realizarse.

## Bibliografía

1 - Baird, R.B. et al. (2017) “2130 - turbidity,” in Standard methods for the examination of water and wastewater. 23rd edn. New York: American Public Health Association. 

2 - Peris-Díaz, M.D. and Krężel, A. (2021) “A guide to good practice in chemometric methods for vibrational spectroscopy, electrochemistry, and hyphenated Mass Spectrometry,” TrAC Trends in Analytical Chemistry, 135, p. 116157. Available at: https://doi.org/10.1016/j.trac.2020.116157. 

3 - Guedes-Alonso, R. et al. (2020) “Pharmaceutical and personal care product residues in a macrophyte pond-constructed wetland treating wastewater from a university campus: Presence, removal and ecological risk assessment,” Science of The Total Environment, 703, p. 135596. Available at: https://doi.org/10.1016/j.scitotenv.2019.135596. 

